---
title: "ST661 - Group Project - London Marathon"
author: 'Group 2: Sam Alexander White, Bimal Oommen John, Akshay Suresh Varma and
  Fernando Nicolas Szeliga Cabezuelo'
date: "2023-11-25"
output: 
  html_document:
    code_folding: hide

---

```{r, include=FALSE}

#Loading Packages

library(tidyverse)
library(GGally)
library(MASS)
library(mosaicData)
library(gridExtra)

```

```{r, message=FALSE}

#data downloading

remotes::install_github("nrennie/LondonMarathon")
data(winners, package = "LondonMarathon")
data(london_marathon, package = "LondonMarathon")

#Joint London Marathon and Winners by Year

joint_marathondata <- dplyr::full_join(london_marathon, winners, by="Year")

# Time conversion from fraction of days to h:m:s

# The time column is in fraction of days,so this was converted to seconds
time_in_seconds <- as.numeric(joint_marathondata$Time) * 24 * 60 * 60

# Formatting the time components
joint_marathondata$Time_Converted <- format(as.POSIXct(time_in_seconds,origin = "1970-01-01", tz = "UTC"), format = "%H:%M:%S")


# NEW VARIABLE: GEOGRAPHICAL LOCATION

winners_countries <- unique(joint_marathondata$Nationality)


geolocation_vector <- sapply(joint_marathondata$Nationality, function(x)
{
  
  if (x== "Norway" | x=="Ireland" |x== "Denmark" |x== "Poland" |x== "Sweden" | x=="Portugal" |x== "France" |x== "Germany" |x== "Belgium" |x== "Switzerland" |x== "Spain" |x== "Italy" | x=="Netherlands")
  {
    return("Rest of Europe")
  }
    else if (x== "United Kingdom")
  {
    return("United Kingdom")
  }
  else if (x== "United States" |x== "Canada" |x== "Mexico")
  {
    return("North America")
  }
  else if (x== "Japan" |x== "Soviet Union" |x== "China")
  {
    return("Asia")
  }
  else if (x== "Kenya" |x== "Morocco" |x== "Ethiopia")
  {
    return("Africa")
  }
  else (x == "Australia")
  {
    return("Oceania")
  }
  
})

joint_marathondata$`Winner's Geographical Location` <- geolocation_vector

## ***** Sam's Code And Variables, Feel Free to Remove ##

## ***** PART 1: Calculating probabilities of being accepted, starting, finishing (Use for Intro?)
# Probability of applicants being accepted
prob_accepted <- joint_marathondata %>%
  group_by(Year) %>%
  summarize(prob_accepted = ifelse(sum(Applicants, na.rm = TRUE) == 0, 0, 
                          sum(Accepted,na.rm=TRUE)/sum(Applicants,na.rm=TRUE)))

# Probability of an accepted athlete starting the race
prob_starting <- joint_marathondata %>%
  group_by(Year) %>%
  summarize(prob_starting = ifelse(sum(Accepted, na.rm = TRUE) == 0, 0, 
                     sum(Starters, na.rm = TRUE) / sum(Accepted, na.rm = TRUE)))

# Calculate the probability of a starting athlete finishing the race
prob_finishing <- joint_marathondata %>%
  group_by(Year) %>%
  summarize(prob_finishing = ifelse(sum(Starters, na.rm = TRUE) == 0, 0, 
                    sum(Finishers, na.rm = TRUE) / sum(Starters, na.rm = TRUE)))

# Add the calculated probabilities to the original data set
joint_marathondata <- joint_marathondata %>%
  left_join(prob_accepted, by = "Year") %>%
  left_join(prob_starting, by = "Year") %>%
  left_join(prob_finishing, by = "Year")

# Add a column for Winning Probability (using total applicants)
joint_marathondata <- joint_marathondata %>%
  group_by(Year) %>%
  mutate(Winning_Prob_Total = ifelse(sum(Applicants,
                              na.rm=TRUE)==0,0,1/sum(Applicants, na.rm = TRUE)))

# Add a column for Winning Probability (using accepted applicants)
joint_marathondata <- joint_marathondata %>%
  group_by(Year) %>%
  mutate(Winning_Prob_Accepted = ifelse(sum(Accepted, 
                        na.rm = TRUE) == 0, 0, 1 / sum(Accepted, na.rm = TRUE)))

## ***** PART 2: Average Times (Akshay's Code & Fernando's Conversion for time)

# Aggregate the data to find the average 'Time' for each 'Category'
average_time_by_category <- aggregate(time_in_seconds ~ Category, data = joint_marathondata, FUN = mean)

## ***** PART 3: Splicing the data into Men and Women
# Overall Mean Time For Marathon
average <- c(0.08837516, 0.07341435, 0.09006440, 0.09929210 # Change to Converted times
# mean(average) # Now that I'm looking at it we mightn't really need this? It's all times averaged I won't include this

# Separating Men's Time
mens_data <- joint_marathondata %>%
  filter(Category == "Men")

# Separating Women's Time
womens_data <- joint_marathondata %>%
  filter(Category == "Women")
```


### Introduction

#### Data Description

The data set encompasses information for the period 1981-2023 related to the London Marathon, an annual event that attracts participants globally. It is divided into two main components: "london_marathon" and "winners". The former provides a comprehensive view of the marathon's yearly broad statistics such as number of applicants, accepted applicants, number of starters, number of finishers, amount of money raised for charity (Â£MM), and chosen charities. The latter focuses on the winners in four competition categories: Men, Women, Wheelchair Men and Wheelchair Women. This data shares the winner's name, nationality, and finishing time in fraction of days. 

#### Data Overview


```{r, fig.cap= "..."}
ggplot(data = joint_marathondata) +
  geom_bar(mapping = aes(x = `Winner's Geographical Location`, fill=Category), position = "fill") + labs(x= "Geographic Area", y= "Density", title =  "Figure 1. Winner's Geographic Distribution by Competition") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```


The leading country in the Men and Female categories is Kenya, with 17 and 14 winners in each category respectively. Second in the male category is the United Kingdom (UK) with 6 winners, followed by Ethiopia with 5 winners. In the female category, Kenya is followed by the UK with 7 winners and Norway with 6 winners.

In the handicapped Male and Female categories, the country with the highest number of winners is the UK, with 16 winners in the male category and 15 in the female category. The UK is followed by Switzerland in the Men category with 6 winners and the United States (US) in the Female category with 6 winners as well. 

#### Research Questions

The following three research questions are being assessed in this report:

**Research Question 1: Are the Kenyan winners the fastest overall in the male and female competition?**

As mentioned in the data overview, the highest number of winners in the male a female categories are from Kenya. In addition, the number of winners from Kenya is 50% or higher than the number of winners from the UK, which is the host country. Hence, with the data available it is possible to analyse whether Kenyan runners are also the fastest overall and if that is a factor to make them the most successful country in these two categories. 


**Research Question 2: ?**


**Research Question 3: Are men's finish times similar to women's finish time?**



### Data Wrangling



```{r}

```

### Fernando Analysis

##### **Research Q1** : are the Kenyan winners in the Male and Female categories the fastest? 

```{r,fig.cap= "..."}

# Time comparison by Nationality Plot. Category: Men

joint_marathondata |> filter(Category=="Men") |> group_by(Nationality) |> summarise(finish_time= mean(Time)) -> men_category


# The time column is in fraction of days,so this was converted to seconds
time_men <- as.numeric(men_category$finish_time) * 24 * 60 * 60

# Formatting the time components
men_category$time_conversion <- format(as.POSIXct(time_men,origin = "1970-01-01", tz = "UTC"), format = "%H:%M:%S")

p_male <- ggplot(men_category, aes(x = reorder(Nationality,finish_time, decreasing=TRUE), y = time_conversion)) +  geom_point() + geom_segment(aes(xend = fct_reorder(Nationality,finish_time)), yend = 0, col = "blue") +
  coord_flip() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) + labs(x= "Nationality", y= "Time", title =  "Men Mean Finish Time")


# Time comparison by Nationality Plot. Category: Women

joint_marathondata |> filter(Category=="Women") |> group_by(Nationality) |> summarise(finish_time= mean(Time)) -> women_category


# The time column is in fraction of days,so this was converted to seconds
time_women <- as.numeric(women_category$finish_time) * 24 * 60 * 60

# Formatting the time components
women_category$time_conversion <- format(as.POSIXct(time_women,origin = "1970-01-01", tz = "UTC"), format = "%H:%M:%S")

p_female <- ggplot(women_category, aes(x = reorder(Nationality,finish_time, decreasing=TRUE), y = time_conversion)) +
  geom_point() + geom_segment(aes(xend = fct_reorder(Nationality,finish_time)), yend = 0, col = "purple") +
  coord_flip() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) + labs(x= "Nationality",y= "Time", title =  "Women Mean Finish Time")


grid.arrange(p_male, p_female, ncol = 2)


```

## Sam Analysis **Research Question 3: Are men's finish times similar to women's finish time?**

```{r}
# Plot Men and Women (Year vs Time)
## CHECK IF CONVERTED TIME IS IN NEW DATA SETS
ggplot() +
  geom_point(data = mens_data, aes(x = Year, y = time_in_seconds), color = "blue") +
  geom_line(data = mens_data, aes(x = Year, y = time_in_seconds), color = "blue", linetype = "solid") +
  geom_point(data = womens_data, aes(x = Year, y = time_in_seconds), color = "pink") +
  geom_line(data = womens_data, aes(x = Year, y = time_in_seconds), color = "pink", linetype = "solid") +
  labs(title = "London Marathon Winners' Times",
       x = "Year",
       y = "Time") +
  theme_minimal()

# Table of Men v Women, used to plot the scatter plots. May not need to include in report, but required to visualise

# Create Table of Men vs Women Winning Times For Each Year
mvw_table <- joint_marathondata %>%
  filter(Category %in% c("Men", "Women")) %>%
  group_by(Year) %>%
  summarize("Men's Mean" = mean(time_in_seconds[Category == "Men"]), # Mean used to account for double winners ?
            "Women's Mean" = mean(time_in_seconds[Category == "Women"]),
            "Annual Mean" = mean(time_in_seconds[Category %in% c("Men", "Women")]))

# Calculating differences in men and women's times, again CHECK CONVERSION and reconsider table.
# Calculating Difference Between Men and Women's Times Each Year

time_difference_table <- joint_marathondata %>%
  filter(Category %in% c("Men", "Women")) %>%
  group_by(Year, Category) %>%
  summarize(Mean_Time = mean(time_in_seconds)) %>% # Mean Used to Account For Double Winner
  spread(Category, Mean_Time) %>%
  mutate(Difference = Women - Men) %>% # Women always have higher time,
  # This keeps difference positive / always says how much faster men were
  select(Year, Men, Women, Difference)

# Plotting Difference Plots (General plot not needed, definitely regression and smooth line!!)

# Plotting Differences Line Plot

ggplot(time_difference_table, aes(x = Year, y = Difference, group = 1)) +
  geom_line(color = "gold", size = 1) +
  geom_point(color = "gold", size = 3) +
  labs(title = "Difference Between Men and Women's Times (London Marathon)",
       x = "Year",
       y = "Time Difference") +
  theme_minimal()

# Using Regression Plot and Smooth to look at linearity and increasing/decreasing

ggplot(time_difference_table, aes(x = Year, y = Difference)) +
  geom_point(color = "gold", size = 3, alpha = 0.7) +
  geom_smooth(method = "loess", color = "blue", se = FALSE) +  # Blue smooth line
  geom_smooth(method = "lm", se = FALSE, color = "red") +  # Red regression line
  labs(title = "Difference Between Men and Women's Times (London Marathon)",
       x = "Year",
       y = "Time Difference") +
  theme_minimal()

```


### Conclusions
