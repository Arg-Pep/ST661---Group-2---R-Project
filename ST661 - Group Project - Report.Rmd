---
title: "ST661 - Group Project - London Marathon"
author: 'Group 2: Sam Alexander White, Bimal Oommen John, Akshay Suresh Varma and
  Fernando Nicolas Szeliga Cabezuelo'
date: "2023-11-25"
output: 
  html_document:
    code_folding: hide

---

```{r, include=FALSE}

#Loading Packages

library(tidyverse)
library(GGally)
library(MASS)
library(mosaicData)
library(gridExtra)

```

```{r, message=FALSE}

#data downloading

remotes::install_github("nrennie/LondonMarathon")
data(winners, package = "LondonMarathon")
data(london_marathon, package = "LondonMarathon")

#Joint London Marathon and Winners by Year

joint_marathondata <- dplyr::full_join(london_marathon, winners, by="Year")

# Time conversion from fraction of days to h:m:s

# The time column is in fraction of days,so this was converted to seconds
time_in_seconds <- as.numeric(joint_marathondata$Time) * 24 * 60 * 60

# Formatting the time components
joint_marathondata$Time_Converted <- format(as.POSIXct(time_in_seconds,origin = "1970-01-01", tz = "UTC"), format = "%H:%M:%S")


# NEW VARIABLE: GEOGRAPHICAL LOCATION

winners_countries <- unique(joint_marathondata$Nationality)


geolocation_vector <- sapply(joint_marathondata$Nationality, function(x)
{
  
  if (x== "Norway" | x=="Ireland" |x== "Denmark" |x== "Poland" |x== "Sweden" | x=="Portugal" |x== "France" |x== "Germany" |x== "Belgium" |x== "Switzerland" |x== "Spain" |x== "Italy" | x=="Netherlands")
  {
    return("Rest of Europe")
  }
    else if (x== "United Kingdom")
  {
    return("United Kingdom")
  }
  else if (x== "United States" |x== "Canada" |x== "Mexico")
  {
    return("North America")
  }
  else if (x== "Japan" |x== "Soviet Union" |x== "China")
  {
    return("Asia")
  }
  else if (x== "Kenya" |x== "Morocco" |x== "Ethiopia")
  {
    return("Africa")
  }
  else (x == "Australia")
  {
    return("Oceania")
  }
  
})

joint_marathondata$`Winner's Geographical Location` <- geolocation_vector

## ***** Sam's Code And Variables, Feel Free to Remove ##

## ***** PART 1: Calculating probabilities of being accepted, starting, finishing (Use for Intro?)
# Probability of applicants being accepted
prob_accepted <- joint_marathondata %>%
  group_by(Year) %>%
  summarize(prob_accepted = ifelse(sum(Applicants, na.rm = TRUE) == 0, 0, 
                          sum(Accepted,na.rm=TRUE)/sum(Applicants,na.rm=TRUE)))

# Probability of an accepted athlete starting the race
prob_starting <- joint_marathondata %>%
  group_by(Year) %>%
  summarize(prob_starting = ifelse(sum(Accepted, na.rm = TRUE) == 0, 0, 
                     sum(Starters, na.rm = TRUE) / sum(Accepted, na.rm = TRUE)))

# Calculate the probability of a starting athlete finishing the race
prob_finishing <- joint_marathondata %>%
  group_by(Year) %>%
  summarize(prob_finishing = ifelse(sum(Starters, na.rm = TRUE) == 0, 0, 
                    sum(Finishers, na.rm = TRUE) / sum(Starters, na.rm = TRUE)))

# Add the calculated probabilities to the original data set
joint_marathondata <- joint_marathondata %>%
  left_join(prob_accepted, by = "Year") %>%
  left_join(prob_starting, by = "Year") %>%
  left_join(prob_finishing, by = "Year")

# Add a column for Winning Probability (using total applicants)
joint_marathondata <- joint_marathondata %>%
  group_by(Year) %>%
  mutate(Winning_Prob_Total = ifelse(sum(Applicants,
                              na.rm=TRUE)==0,0,1/sum(Applicants, na.rm = TRUE)))

# Add a column for Winning Probability (using accepted applicants)
joint_marathondata <- joint_marathondata %>%
  group_by(Year) %>%
  mutate(Winning_Prob_Accepted = ifelse(sum(Accepted, 
                        na.rm = TRUE) == 0, 0, 1 / sum(Accepted, na.rm = TRUE)))

## ***** PART 2: Average Times (Akshay's Code & Fernando's Conversion for time)

# Aggregate the data to find the average 'Time' for each 'Category'
average_time_by_category <- aggregate(time_in_seconds ~ Category, data = joint_marathondata, FUN = mean)

## ***** PART 3: Splicing the data into Men and Women
# Overall Mean Time For Marathon
average <- c(0.08837516, 0.07341435, 0.09006440, 0.09929210 # Change to Converted times
# mean(average) # Now that I'm looking at it we mightn't really need this? It's all times averaged I won't include this

# Separating Men's Time
mens_data <- joint_marathondata %>%
  filter(Category == "Men")

# Separating Women's Time
womens_data <- joint_marathondata %>%
  filter(Category == "Women")
```


### Introduction

#### Data Description

The data set encompasses information for the period 1981-2023 related to the London Marathon, an annual event that attracts participants globally. It is divided into two main components: "london_marathon" and "winners". The former provides a comprehensive view of the marathon's yearly broad statistics such as number of applicants, accepted applicants, number of starters, number of finishers, amount of money raised for charity (Â£MM), and chosen charities. The latter focuses on the winners in four competition categories: Men, Women, Wheelchair Men and Wheelchair Women. This data shares the winner's name, nationality, and finishing time in fraction of days. 

#### Data Overview


```{r, fig.cap= "..."}
ggplot(data = joint_marathondata) +
  geom_bar(mapping = aes(x = `Winner's Geographical Location`, fill=Category), position = "fill") + labs(x= "Geographic Area", y= "Density", title =  "Figure 1. Winner's Geographic Distribution by Competition") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```


The leading country in the Men and Female categories is Kenya, with 17 and 14 winners in each category respectively. Second in the male category is the United Kingdom (UK) with 6 winners, followed by Ethiopia with 5 winners. In the female category, Kenya is followed by the UK with 7 winners and Norway with 6 winners.

In the handicapped Male and Female categories, the country with the highest number of winners is the UK, with 16 winners in the male category and 15 in the female category. The UK is followed by Switzerland in the Men category with 6 winners and the United States (US) in the Female category with 6 winners as well. 

#### Research Questions

The following three research questions are being assessed in this report:

**Research Question 1: Are the Kenyan winners the fastest overall in the male and female competition?**

As mentioned in the data overview, the highest number of winners in the male and female categories are from Kenya. In addition, the number of winners from Kenya is 50% or higher than the number of winners from the UK, which is the host country. Hence, with the data available it is possible to analyse whether Kenyan runners are also the fastest overall and if that is a factor to make them the most successful country in these two categories. 


**Research Question 2: ?**


**Research Question 3: Are men's finish times similar to women's finish time?**
With Kenya having a similar number of winners in the categories "Men" and "Women", this led to an investigation of completion time for each gender. The male winners presented shorter running times than female winners, which led to further analysis to discover by how much and if any trends were evident.




### Data Wrangling



```{r}

```

### Fernando Analysis

##### **Research Q1** : are the Kenyan winners in the Male and Female categories the fastest? 

```{r,fig.cap= "..."}

# Time comparison by Nationality Plot. Category: Men

joint_marathondata |> filter(Category=="Men") |> group_by(Nationality) |> summarise(finish_time= mean(Time)) -> men_category


# The time column is in fraction of days,so this was converted to seconds
time_men <- as.numeric(men_category$finish_time) * 24 * 60 * 60

# Formatting the time components
men_category$time_conversion <- format(as.POSIXct(time_men,origin = "1970-01-01", tz = "UTC"), format = "%H:%M:%S")

p_male <- ggplot(men_category, aes(x = reorder(Nationality,finish_time, decreasing=TRUE), y = time_conversion)) +  geom_point() + geom_segment(aes(xend = fct_reorder(Nationality,finish_time)), yend = 0, col = "blue") +
  coord_flip() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) + labs(x= "Nationality", y= "Time", title =  "Men Mean Finish Time")


# Time comparison by Nationality Plot. Category: Women

joint_marathondata |> filter(Category=="Women") |> group_by(Nationality) |> summarise(finish_time= mean(Time)) -> women_category


# The time column is in fraction of days,so this was converted to seconds
time_women <- as.numeric(women_category$finish_time) * 24 * 60 * 60

# Formatting the time components
women_category$time_conversion <- format(as.POSIXct(time_women,origin = "1970-01-01", tz = "UTC"), format = "%H:%M:%S")

p_female <- ggplot(women_category, aes(x = reorder(Nationality,finish_time, decreasing=TRUE), y = time_conversion)) +
  geom_point() + geom_segment(aes(xend = fct_reorder(Nationality,finish_time)), yend = 0, col = "purple") +
  coord_flip() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) + labs(x= "Nationality",y= "Time", title =  "Women Mean Finish Time")


grid.arrange(p_male, p_female, ncol = 2)


```
**Research Question 3: Are Men's Finishing Times Similar To That of Women's?**

```{r, include=FALSE}

# New Separation Different To Fernando
# Men
winners %>%
  filter(Category == "Men") %>%
  group_by(Year, Nationality) %>%
  summarise(finish_time = mean(Time)) %>%
  mutate(time_seconds = finish_time * 24 * 60 * 60,
         time_conversion = format(as.POSIXct(time_seconds, origin = "1970-01-01", tz = "UTC"), format = "%H:%M:%S")) -> men_data

# Women
winners %>%
  filter(Category == "Women") %>%
  group_by(Year, Nationality) %>%
  summarise(finish_time = mean(Time)) %>%
  mutate(time_seconds = finish_time * 24 * 60 * 60,
         time_conversion = format(as.POSIXct(time_seconds, origin = "1970-01-01", tz = "UTC"), format = "%H:%M:%S")) -> women_data

```
```{r MenVsWomen, fig.cap="Figure 3.1", fig.width=5, fig.height=2, echo=FALSE}
# Creating the Men's and Women's Graph (Time in Hours)
MenVsWomen <- ggplot() +
  geom_point(data = men_data, aes(x = Year, y = time_seconds/3600), color = "blue") +
  geom_line(data = men_data, aes(x = Year, y = time_seconds/3600), color = "blue", linetype = "solid") +
  geom_point(data = women_data, aes(x = Year, y = time_seconds/3600), color = "pink") +
  geom_line(data = women_data, aes(x = Year, y = time_seconds/3600), color = "pink", linetype = "solid") +
  labs(title = "London Marathon Winners' Times",
       x = "Year",
       y = "Time (Hours)") +
theme_minimal()
```
```{r include=FALSE}
# Calculating differences (mins) between Men and Women's times into table

time_difference_table <- winners %>%
  filter(Category %in% c("Men", "Women")) %>%
  group_by(Year, Category) %>%
  summarize(Mean_Time = mean(Time*24*60)) %>% # Mean Used to Account For Double Winner
  spread(Category, Mean_Time) %>%
  mutate(Difference = Women - Men)
```
```{r diff_plot, fig.cap="Figure 3.2", fig.width=5, fig.height=2, echo=FALSE}
# Plotting differences on a scatter plot including smooth and regression line.
diff_plot<- ggplot(time_difference_table, aes(x = Year, y = Difference)) +
  geom_point(color = "#339966", size = 3, alpha = 0.7) +
  geom_smooth(method = "loess", color = "#3399FF", se = FALSE) +  # Blue smooth line
  geom_smooth(method = "lm", se = FALSE, color = "#CC3333") +  # Red regression line
  labs(title = "Difference Between Men and Women's Times",
       x = "Year",
       y = "Time Difference (Mins)") +
  theme_minimal()
```
In examining the question of whether male winners are faster than their female competition, and by how much, an analysis of winners' times revealed a consistent trend (Fig 3.1). Across corresponding years, the male winners consistently achieved faster finishing times compared to their female counterparts. To visualize and quantify these differences, a scatter plot was constructed, with the y-axis representing the time differences in minutes between genders, and the x-axis denoting the year the data was recorded from. This is shown below in Fig 3.2. 

```{r, fig.width=10, fig.height=4, echo=FALSE}

grid.arrange(MenVsWomen, diff_plot, ncol = 2)

```

The regression line fitted to the data exhibited a negative slope, indicating a decreasing trend in the time differences over the years. This suggests that, on average, the historical gap in athletic performance and finishing times between male and female winners has been diminishing. The smooth curvature observed in the regression line adds nuance to the analysis, hinting at potential factors influencing the convergence of winning times over time. Further exploration into the underlying variables contributing to this trend could provide valuable insights into the evolving dynamics of performance in marathon competitions. 

Seeing as the data collected ranges from the years 1981 to 2021, many socio-economic factors could influence this apparent trend. Inclusivity and diversity are at the forefront of society in this modern age, with sporting organisations such as the NBA and NFL broadcasting female tournaments and offering professional training opportunities equal in quality to those offered to Men. Many common brands such as Always are beginning to use targeted experiential marketing to inspire women and the female youth to pursue opportunities and sponsorships that have not been open to them in previous years.




### Conclusions
